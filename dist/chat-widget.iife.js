(function(){"use strict";const m=(t="loplat-new-ai-btn")=>{const n=document.createElement("button");return n.id=t,n},E=(t="loplat-new-ai-popup",n="http://localhost:5001/")=>{const e=document.createElement("div");return e.id=t,e.innerHTML=`
      <iframe
        src=${n}
        class="loplat-new-ai"
      >
      </iframe>
  `,e},c="highlight-visible",p=()=>{const t=new IntersectionObserver(e=>{e.forEach(o=>{const s=o.target;o.isIntersecting?s.classList.add(c):s.classList.remove(c)})},{root:null,rootMargin:"0px",threshold:.5}),n=e=>{e.nodeType===Node.ELEMENT_NODE&&e.nodeName!=="SCRIPT"&&e.nodeName!=="STYLE"?Array.from(e.childNodes).forEach(n):e.parentElement&&t.observe(e.parentElement)};n(document.body)},l=({popup:t,type:n,...e})=>{var s;const o=t.querySelector("iframe");o&&((s=o.contentWindow)==null||s.postMessage({type:n,value:e},"*"))},f=t=>l({popup:t,type:"URL_CHANGE",url:window.location.href}),N=t=>{const{data:n}=t;typeof n!="object"||n===null||!("type"in n&&n.type==="highlight")||window.ChatWidget.highlightText(`${t.data.value}`)},w=(t,n)=>{const e=t.target;if(!e)return;const o={x:t.clientX,y:t.clientY};if(!(e instanceof HTMLElement))return l({popup:n,type:"MOUSE_CLICK",...o});const s=e.tagName,i=e.id?`#${e.id}`:"",r=e.className?`.${e.className.split(" ").filter(d=>d!==c).join(".")}`:"",a=`${s}${i}${r}`;return l({popup:n,type:"MOUSE_CLICK",...o,tagPath:a,tagContent:e.innerText})},h=()=>{const t=m(),n=E();document.body.appendChild(t),document.body.appendChild(n);let e=!1;t.addEventListener("click",()=>{n.style.display=e?"none":"block",window.dispatchEvent(new Event("popstate")),e=!e});const o=history.pushState;history.pushState=function(...i){o.apply(this,i),arguments[0].isReplace||window.dispatchEvent(new Event("popstate"))};const s=history.replaceState;history.replaceState=function(...i){arguments[0].isReplace=!0,s.apply(this,i)},window.addEventListener("popstate",()=>f(n)),window.addEventListener("message",N),window.addEventListener("click",i=>w(i,n)),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",p):p()},y=t=>{document.querySelectorAll(`.${t}`).forEach(e=>{const o=e.parentElement;o&&o.replaceChild(document.createTextNode(e.textContent||""),e)})},u=(t,n,e)=>{if(t.nodeType===Node.ELEMENT_NODE&&t.nodeName!=="SCRIPT"&&t.nodeName!=="STYLE")return Array.from(t.childNodes).forEach(a=>u(a,n,e));if(!(t.nodeType===Node.TEXT_NODE&&!!t.nodeValue))return;const i=t.nodeValue??"",r=t.parentElement;if(i.includes(n)&&r){const a=new RegExp(`(${n})`,"gi"),d=i.replace(a,`<span class="${e}">$1</span>`),g=document.createElement("span");g.innerHTML=d,r.replaceChild(g,t)}},T=(t,n="highlight")=>{t&&(y(n),u(document.body,t,n))};window.ChatWidget={init:h,highlightText:T},h()})();
